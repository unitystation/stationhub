name: .NET Build and Test

on:
  push:
    branches:
      - "develop"
  pull_request:
    branches:
      - "*"

env:
  DOTNET_VERSION: '6.0.x'

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3
      - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Format check
        run: |
          dotnet format --verify-no-changes

      - name: Test
        run: |
          dotnet test

  build-windows:
    name: Build Windows
    runs-on: windows-latest
    steps:
      # Setup
      - uses: actions/checkout@v3
      - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      # Build
      - name: Publish
        run: |
          dotnet publish --configuration Release --runtime win-x64 --self-contained true --property PublishDir=./build/windows

      # Upload
      - name: Upload Build
        uses: actions/upload-artifact@v3
        with:
          name: StationHub-win-x64
          path: ./build/windows

  build-macos:
    name: Build MacOS
    runs-on: macos-latest
    steps:
      # Setup
      - uses: actions/checkout@v3
      - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      # Build
      - name: Publish
        run: |
          dotnet publish --configuration Release --runtime osx-x64 -t:BundleApp -p:RuntimeIdentifier=osx-x64 -p:UseAppHost=true --self-contained true --property PublishDir=./build/macos \
          && sudo chmod +x ./build/macos/StationHub.app/Contents/MacOS/StationHub \
          && cd ./build/macos \
          && tar -cvf ./build/macos/StationHub.tar StationHub.app

      # Upload
      - name: Upload Build
        uses: actions/upload-artifact@v3
        with:
          name: StationHub-osx-x64
          path: ./build/macos/StationHub.tar

  build-linux:
    name: Build Linux
    runs-on: ubuntu-latest
    steps:
      # Setup
      - uses: actions/checkout@v3
      - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      # Build
      - name: Publish
        run: |
          dotnet publish --configuration Release --runtime linux-x64 --self-contained true --property PublishDir=./build/linux

      # Upload
      - name: Upload Build
        uses: actions/upload-artifact@v3
        with:
          name: StationHub-linux-x64
          path: ./build/linux

  build-flatpak:
    name: Build Linux Flatpak
    runs-on: ubuntu-latest
    steps:
      # Setup
      - uses: actions/checkout@v3
      - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
      
      # Build
      - name: Test Flatpak Build
        run: |
          dotnet publish --framework net6.0 --runtime linux-x64 --configuration Release --self-contained true /p:DefineConstants="FLATPAK" /p:DisableBeauty=true