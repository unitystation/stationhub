# Flatpak Maintenance
## Flathub and Flatpak Explaination
The Flatpak for StationHub is distributed via Flathub.

Flatpak is the underlying technology, while Flathub can be thought of as a software store (though everything there is free). 
Flathub has some requirements that it enforces on packages being distrubuted through there.
If you're making any updates here, its worth just double checking in with their application guidelines (linked below).

The main thing to note is that the build servers disable internet access during the build process, so all dependencies must be defined ahead of time.

## Important Links
- Flatpak builder tools: https://github.com/flatpak/flatpak-builder-tools
- Flathub application guidelines: https://github.com/flathub/flathub/wiki/App-Requirements
- Flathub maintenance guide: https://github.com/flathub/flathub/wiki/App-Maintenance
- Flathub package repo: https://github.com/flathub/org.unitystation.StationHub

## Updating the Flatpak
### No NuGet Updates
If there are no NuGet updates then the update process should be quite simple.

In the Flathub package repo there is a line at the top of `org.unitystation.StationHub.yaml` that defines the commit hash that the build server will check out before it builds.
It should look something like this:
```yaml
  - name: StationHub
    sources:
      - type: git
        url: https://github.com/unitystation/stationhub
        commit: 45f68bef1e83e004262534e52c8c4f7119fc89b6 # <-- This is the line you want
```

It should be as easy as updating that one line and opening a PR.

### Has NuGet Updates
Inside the Flatpak builder tools repo there is a Python script which will generate a `sources.json` file based on the .csproj for the file.

You'll need to run this script for `UnitystationLauncher.csproj` and replace the `sources.json` in the repo with the one generated.
One thing to note, is that we are using self contained builds in the Flatpak, so you'll also need to add these two packages to the top of the list:
```json
    {
        "type": "file",
        "url": "https://api.nuget.org/v3-flatcontainer/microsoft.aspnetcore.app.runtime.linux-x64/6.0.14/microsoft.aspnetcore.app.runtime.linux-x64.6.0.14.nupkg",
        "sha512": "d10f0e53ac2872fdad7c2f5efc4ead7326ba92bf63ca7a4db473eb9940d0a39f513548ddf7ddfaf114c4724a4ef3b8a7180b8a51aa9a5ffc2938d81db8b4e473",
        "dest": "nuget-sources",
        "dest-filename": "microsoft.aspnetcore.app.runtime.linux-x64.6.0.14.nupkg"
    },
    {
        "type": "file",
        "url": "https://api.nuget.org/v3-flatcontainer/microsoft.netcore.app.runtime.linux-x64/6.0.14/microsoft.netcore.app.runtime.linux-x64.6.0.14.nupkg",
        "sha512": "0168110952af6f3c3de82385d3638ee9bf35df0dd7f51042f5a70acf26d56d0403a2f1c07fc96fd7327726c2d9b624fd244b7ed335907a94e30723c2e6b881eb",
        "dest": "nuget-sources",
        "dest-filename": "microsoft.netcore.app.runtime.linux-x64.6.0.14.nupkg"
    },
```

These are required for .NET self contained builds, but are not generated by that tool. If there is an updated version of those it should be as simple as replacing the version numbers in the URL and then just downloading it to check what the sha512sum of the file is locally.

## Other info
### Permissions
Flatpaks have a permissions system, in `org.unitystation.StationHub.yaml` we have these permissions setup currently:
```yaml
finish-args:
  - --socket=x11
  - --share=ipc
  - --device=dri
  - --socket=pulseaudio
  - --share=network
```

From what I understand this basically says to allow windowing with `socket=x11`, allow interprocess communication with `share=ipc` (I guess this would be for something like Discord integration?), gives access to use the GPU drivers with `device=dri`, access to play sound with `socket=pulseaudio`, and network access with `share=network`.

### Dotnet version
Dotnet versions are handled in a fairly straightforward way, you can just specify the SDK version you want to use at the top of `org.unitystation.StationHub.yaml` with a line like so:
```yaml
sdk-extensions:
  - org.freedesktop.Sdk.Extension.dotnet6
```

And in the build step you need to specify this again:
```yaml
    build-commands:
      - '. /usr/lib/sdk/dotnet6/enable.sh; dotnet publish --framework net6.0 [...]'
```

### Metainfo
The meta information for the app is specified in the metainfo XML file here: https://github.com/unitystation/stationhub/blob/develop/UnitystationLauncher/Assets/org.unitystation.StationHub.metainfo.xml

This will be verified as valid before the build is accepted, and the guidelines for this are very strict.
For example, the releases must be specified in newest to oldest order or the build is rejected.

### Desktop entry
The desktop entry is specified in this file: https://github.com/unitystation/stationhub/blob/develop/UnitystationLauncher/Assets/org.unitystation.StationHub.desktop
